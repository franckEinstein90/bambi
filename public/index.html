
<script type= "text/javascript" defer="defer">

  AJS.toInit(function($){
// Shows the dialog when the "Show dialog" button is clicked
AJS.$("#dialog-show-button").click(function(e) {
    e.preventDefault();
    AJS.dialog2("#demo-dialog").show();
});

AJS.$("#select-previous-month").click(function(e) {
});
AJS.$("#select-next-month").click(function(e) {
});
    //furnction  to capture variables from get request
     jQuery.extend({
            getValues:function(url){
              var result=null;
              jQuery.ajax({
                url:url,
                type: 'get',
                async:false,
                success: function(data){
                  result=data;
                }
              });
              return result;
            }
        });

        //gets the current page's information
       var currentPage =  {
               pageID : $content.getIdAsString(),
               setValues: function(){
                 this.path = contextPath + "/rest/api/content/" + this.pageID;
                 this.result = jQuery.getValues(this.path + "?expand=body.storage,version");
                 this.pageTitle = this.result["title"];
                 this.versionNumber = this.result["version"]["number"];
                 this.pageBody = this.result["body"]["storage"]["value"];
               }
             };


       currentPage.setValues();
      // eventDialog.setCurrentPage(currentPage);


      //format the event list
      $("h1:contains('Events')").before("<div id='eventlist' class='eventList'>hello</div>");

      $("h1:contains('Events') + ul li").append("<span class='aui-icon aui-icon-small aui-iconfont-edit-filled'>Insert meaningful text here for accessibility</span>");
      $("h1:contains('Events'), h1:contains('Events') + ul").appendTo("#eventlist");


       //Read the list of events stored on the page
       let eventList = currentPage.pageBody.match(/<h1>Events<\/h1><ul>(.+?)<\/ul>/)[0].split("<li>").filter(listElt =>/^Event from/.test(listElt));
       var format = function(str){
                        var vals = /Event from ([\d-]+) to ([\d-]+)\:\s(.*?)<\/li>/.exec(str).slice(1,4);
                        return vals.map(ev => ev.replace(/\-/g,"_"));
                };
                eventUtils.processEventStrArray(eventList, format);



if (typeof dateUtils === 'object') {
  console.log('dateUtils loaded');
}else{
console.log('dateUtils notloaded');
}



function populateTable(theMonth, theYear) {

    // initialize date-dependent variables
    let firstDay = calendarSettings.firstDayOfMonth;
    let howMany = dateUtils.monthLength(theYear, theMonth);
    $("#tableHeader").html(`<h1>${dateUtils.monthIdxToStr(theMonth)} ${theYear}</h1>`);

   // initialize vars for table creation
    let dayCounter = 1;
    $("#tableBody").html("");
    while (dayCounter <= howMany) {
  	  let newRow = "<TR>";
  	  let addedDays = [];
  	  for(let i=0; i<7; i++){
  		if(dayCounter > howMany) {break;}
  		  if(($("#tableBody tr").length >= 1) || (i >= firstDay)){
                       let dayID =dateUtils.dayStamp(theYear, theMonth, dayCounter);
                       addedDays.push(dayID);
                       newRow += "<td ID='" + dayID + "' class='" + ((dayID.localeCompare(dateUtils.dayStamp()) == 0 )?"day":"today") + "'>";
                       newRow += dayCounter++;
                       var eventOnThatDay = eventUtils.eventsAt(dayID);
                       if(eventOnThatDay.length > 0){
                                             newRow += "<span style='color:red'><a id='"+
                                             dayID +"' title='" +
                                             eventOnThatDay.map(ev=>ev.eventTitle).join(",") +"'> &nbsp;" +
                                             eventOnThatDay.length + " event(s)</a></span>";}
                       newRow += "</td>";
		  }
		  else{
			  newRow += "<td class='day'></td>";
		  }
	  }
	  newRow += "</tr>";
	  $("#tableBody").append(newRow);
  for(let i=0; i<addedDays.length; i++){
      $("#"+addedDays[i]).click(function(){showDayDialog(addedDays[i]);});
    }
  }
}
//function called when user clicks on a day
function showDayDialog(dayID){
    eventDialog.setParams(dayID, currentPage);
    eventDialog.show();
}
function fillYears() {
      var today = new Date();
      var thisYear = today.getFullYear();
      var yearChooser = document.dateChooser.chooseYear;
      for (i = thisYear; i < thisYear + 5; i++) {
          yearChooser.options[yearChooser.options.length] = new Option(i, i)
      }
      setCurrMonth(today)
  }
  function setCurrMonth(today) {
      document.dateChooser.chooseMonth.selectedIndex = today.getMonth()
  }

  function highLightEventsInCalendar(){
      let todayDate = Date.now();
      console.log(
        todayDate.getDate().toString().padStart(2,'0'));
      $("#2019-03-15").css( "color", "red" );
  }
	fillYears();

	$("#dateChooser").change(function(){
    let theMonth = document.dateChooser.chooseMonth.selectedIndex;
    let theYear = parseInt(document.dateChooser.chooseYear.options[document.dateChooser.chooseYear.selectedIndex].text);
    calendarSettings.setValues(
      parseInt(document.dateChooser.chooseYear.options[document.dateChooser.chooseYear.selectedIndex].text),
      document.dateChooser.chooseMonth.selectedIndex);
     populateTable(theMonth, theYear);
	  });

 calendarSettings.setValues(
      parseInt(document.dateChooser.chooseYear.options[document.dateChooser.chooseYear.selectedIndex].text),
      document.dateChooser.chooseMonth.selectedIndex);
    let theMonth = document.dateChooser.chooseMonth.selectedIndex;
    let theYear = parseInt(document.dateChooser.chooseYear.options[document.dateChooser.chooseYear.selectedIndex].text);
	  populateTable(theMonth, theYear);

  });
</script>


<HR>
<TABLE ID="calendarTable" class="aui">
<TR>
    <TH><button id="dialog-show-button" class="aui-button">Add an event</button></TH>
    <TH><span id="select-previous-month" class="aui-icon aui-icon-large aui-iconfont-arrows-left monthSelector">Insert meaningful text here for accessibility</span></TH>
    <TH ID="tableHeader" COLSPAN=4></TH>
    <TH><span id="select-next-month" class="aui-icon aui-icon-large aui-iconfont-arrows-right monthSelector">Insert meaningful text here for accessibility</span></TH>
</TR>
<TR><TH>Sun</TH><TH>Mon</TH><TH>Tue</TH><TH>Wed</TH>
<TH>Thu</TH><TH>Fri</TH><TH>Sat</TH></TR>
<TBODY ID="tableBody"></TBODY>
<TR>
    <TD COLSPAN=7>
    <FORM name="dateChooser" ID="dateChooser" class="aui">
        <SELECT ID="chooseMonth" name="chooseMonth">
            <OPTION SELECTED>January<OPTION>February
            <OPTION>March<OPTION>April<OPTION>May
            <OPTION>June<OPTION>July<OPTION>August
            <OPTION>September<OPTION>October
            <OPTION>November<OPTION>December
    </SELECT>
    <SELECT NAME="chooseYear">
    </SELECT>
    </FORM>
   </TD>
</TR>
</TABLE>
