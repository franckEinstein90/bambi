## Macro title: Calendar for parks confluence
## Macro has a body: N
##
## Developed by: Franck Binard
## Installed by: Franck
## @noparams

$action.getHelper().renderConfluenceMacro("{015_dateutils}")
$action.getHelper().renderConfluenceMacro("{009_a_calendar_styles}")
$action.getHelper().renderConfluenceMacro("{009_a_event_form}")


<script type= "text/javascript" defer="defer">
const appData = {
	"monthsEn" :  ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
}

var makeEventView = function(index, bDate, eDate, evBody) {
    let re = /(.+)\s*\:(.+)/,
        eventTitle = evBody,
        eventDescription,
    found = evBody.match(re);
    if (found) { //the event also contains a long description
        eventTitle = found[1];
        eventDescription = found[2];
    }
    evID = eventUtils.processDateRange(bDate, eDate, eventTitle, eventDescription);
    let htmlStr = "<div class='hidden'>" + evID + "</div>" +
        "<div class='eventHeaderRow'><div class='eventTitle'>" + eventTitle + "</div>" +
        "<div class='event-controls'>" +
        "<span class='aui-icon aui-icon-small aui-iconfont-edit event-edit-btn' id='" + evID + "Edit'>Insert meaningful text here for accessibility</span>" +
        "<span class='aui-icon aui-icon-small aui-iconfont-delete event-edit-btn'>Insert meaningful text here for accessibility</span>" +
        "</div></div>" + "<div class='event-dates'>" + bDate;

    if (bDate.localeCompare(eDate) != 0) {
        htmlStr += " to " + eDate
    }
    htmlStr += "</div>";
    if (typeof(eventDescription) !== "undefined") {
        htmlStr += "<div id='event" + index + "' class='aui-expander-content'>";
        htmlStr += eventDescription;
        htmlStr += "</div><a id='replace-text-trigger' data-replace-text='Read less' class='aui-expander-trigger' aria-controls='event" + index + "'>Read more</a></br>";
    }
    return {
        html: "<div class='eventView'>" + htmlStr + "</div>",
        id: evID
    };
};

  AJS.toInit(function($){

          console.log("1. setting up event dialog controller");


const eventDialogController = (function() {

    let dialogAction = undefined,
    eventBeginDateField = "#event-dialog-begin-date",
    eventEndDateField = "#event-dialog-end-date",
    dateStampToDate = function(dayStamp){
    dateUtils.setSeparator("-");
    return dateUtils.dayStampToDate(dayStamp)
   },
   calendarBlankEvent = function(dayStamp){
     let beginDate = dateStampToDate(dayStamp);
     return new eventUtils.Event(beginDate, beginDate, "", "");
   },
   setEventFormValues = function(ev) {
       dateUtils.setSeparator('-');
       AJS.$(eventBeginDateField).val(dateUtils.dateToDayStamp(ev.beginDate));
       AJS.$(eventEndDateField).val(dateUtils.dateToDayStamp(ev.endDate));
       if(ev.eventTitle){
         AJS.$("#event-dialog-title").val(ev.eventTitle);
       }
       if(ev.eventDescription){
        AJS.$("#event-dialog-description").val(ev.eventDescription);
       }
   },
   setEventDialogHeader = function(headerTitle){
       AJS.$("#event-dialog-action").text(headerTitle);
   },
   validateFormInfo = function(){
     let fieldAsDate = function(fieldID){
       return dateUtils.dayStampToDate(AJS.$(fieldID).val());
     },
     beginDate = fieldAsDate(eventBeginDateField),
     endDate = fieldAsDate(eventEndDateField);
     console.log("validating");
   }
     return {

      dialogActions : {create: 1, edit: 2},

      getDialogAction: function(){
           return dialogAction;
         },

      showEdit: function(evID) {
           dialogAction = eventDialogController.dialogActions.edit;
           setEventDialogHeader("Modifying existing event");
           let ev = eventUtils.get(evID);
           setEventFormValues(ev);
           AJS.dialog2("#event-dialog").show();
         },

      showNew: function(dayStamp) {
           dialogAction = eventDialogController.dialogActions.create;
           setEventDialogHeader("Creating new event");
           let ev = calendarBlankEvent(dayStamp);
           setEventFormValues(ev);
           AJS.dialog2("#event-dialog").show();
         },

      publish: function(ev){
           console.log("publishing event to page");
           validateFormInfo();
         }
     }
 })();




 /****************************
  * Calendar Settings Settings
  *****************************/
  console.log("UI event handlers");
  calendarSettings.setValues();
  AJS.$("#select-previous-month").click(function(e) {
      calendarSettings.previousMonth();
      setFormValues();
      populateCalendarTable();
    });

    AJS.$("#select-next-month").click(function(e) {
      calendarSettings.nextMonth();
      setFormValues();
      populateCalendarTable();
    });

 /***********************************************
 * Event handlers for event dialog
 ***********************************************/
  AJS.$("#dialog-submit-button").click(function (e) {
         eventDialogController.publish();
  });


  /************************************************/
 /*Event List Settings **************************/
  $("h1:contains('Events')").before("<div id='eventlist' class='eventList'></div>");
    let re = /Event from (\d{4}\-\d{2}\-\d{2}) to (\d{4}\-\d{2}\-\d{2})\:\s(.+)/;
    dateUtils.setSeparator("-");

  AJS.$("h1:contains('Events') + ul li").each(function(index) {
        let found = ($(this).text()).match(re);
        if (found) {
            let eventViewPanel = makeEventView(index, found[1], found[2], found[3]);
            AJS.$("#eventlist").append(eventViewPanel.html);
            AJS.$("#" + eventViewPanel.id + "Edit").click(function() {
                eventDialogController.showEdit(eventViewPanel.id);
            });
        }
    });


    AJS.$("h1:contains('Events') + ul").remove();
    AJS.$("h1:contains('Events')").remove();


// Shows the dialog when the "Show dialog" button is clicked
AJS.$("#dialog-show-button").click(function(e) {
    e.preventDefault();
    AJS.dialog2("#event-dialog").show();
});

    //furnction  to capture variables from get request
     jQuery.extend({
            getValues:function(url){
              var result=null;
              jQuery.ajax({
                url:url,
                type: 'get',
                async:false,
                success: function(data){
                  result=data;
                }
              });
              return result;
            }
        });

        //gets the current page's information
       var currentPage =  {
               pageID : $content.getIdAsString(),
               setValues: function(){
                 this.path = contextPath + "/rest/api/content/" + this.pageID;
                 this.result = jQuery.getValues(this.path + "?expand=body.storage,version");
                 this.pageTitle = this.result["title"];
                 this.versionNumber = this.result["version"]["number"];
                 this.pageBody = this.result["body"]["storage"]["value"];
               }
             };


       currentPage.setValues();


if (typeof dateUtils === 'object') {
  console.log('dateUtils loaded');
}else{
console.log('dateUtils notloaded');
}


var formatUIEvent = function(ev){
  return "<a data-aui-trigger aria-controls='more-details' href='#more-details'>" + ev.eventTitle.substring(0,5) + "..." +
		"</a>";
}

var populateCalendarTable = function( ) {

    // initialize date-dependent variables
    let firstDay = calendarSettings.firstDayOfMonth,
         howMany = calendarSettings.monthLength,
         dayCounter = 1;

    AJS.$("#tableCalendar-title").html("<h1>" + dateUtils.monthIdxToStr(calendarSettings.month) + " " + calendarSettings.year + "</h1>");
    AJS.$("#tableBody").empty();
    while (dayCounter <= howMany) {
  	  let newRow = "<TR>";
  	  let addedDays = [];
  	  for(let i=0; i<7; i++){
  		if(dayCounter > howMany) {break;}
  		  if((AJS.$("#tableBody tr").length >= 1) || (i >= firstDay)){
                           let dayID = dateUtils.dayStamp(calendarSettings.year, calendarSettings.month, dayCounter),
                              eventsOnThatDay = eventUtils.eventsOn(dayID);
                       addedDays.push(dayID);
                       newRow += "<td ID='" + dayID + "' class='" + ((dayID.localeCompare(dateUtils.dayStamp()) == 0 )?"today":"day") + "'>";
                       newRow += dayCounter++;
                       if(eventsOnThatDay.length > 0){
                                              newRow += "<div class='dayEvents'>";
                      newRow += eventsOnThatDay.map(formatUIEvent).join("<br/>");
	              newRow += "</div>";
                   }
                    newRow += "</td>";
		  }
		  else{
			  newRow += "<td class='day'></td>";
		  }
	  }
	  newRow += "</tr>";
	  AJS.$("#tableBody").append(newRow);
  for(let i=0; i<addedDays.length; i++){
      $("#"+addedDays[i]).click(function(){showDayDialog(addedDays[i]);});
    }
  }
}
//function called when user clicks on a day
let showDayDialog = function(dayID){
   eventDialogController.showNew(dayID);
}

let populateFormOptions = function() {
        let makeOption = (idx, value) => `<option value="${idx}">${value}</option>`;
        let yearChooser = document.dateChooser.chooseYear;
        for (i = calendarSettings.beginYear(); i < calendarSettings.endYear(); i++) {
            yearChooser.options[yearChooser.options.length] = new Option(i, i)
        }
        appData['monthsEn'].forEach((month, idx) => AJS.$("#chooseMonth").append(makeOption(idx, month)));
        setFormValues();
    }


    var setFormValues = function() { //updates the form values based on the calendarSettings values
      document.dateChooser.chooseMonth.selectedIndex = calendarSettings.month;
      let yearIDX =calendarSettings.yearIdx();
      document.dateChooser.chooseYear.selectedIndex = yearIDX;
    }

    var getFormValues = function() { //updates the calendarSettings values based on the form values
      calendarSettings.setValues(
            parseInt(document.dateChooser.chooseYear.options[document.dateChooser.chooseYear.selectedIndex].text),
            document.dateChooser.chooseMonth.selectedIndex);
        populateCalendarTable();
    }

  populateFormOptions();
  $("#dateChooser").change(function(){
    getFormValues();
  });
  getFormValues();
});
</script>


<HR>
<TABLE ID="calendarTable" class="aui">
<thead id="tableCalendar-header">
<TR>
    <TH><button id="dialog-show-button" class="aui-button">Add an event</button></TH>
    <TH><span id="select-previous-month" class="aui-icon aui-icon-large aui-iconfont-arrows-left monthSelector">Insert meaningful text here for accessibility</span></TH>
    <TH ID="tableCalendar-title" COLSPAN=4></TH>
    <TH><span id="select-next-month" class="aui-icon aui-icon-large aui-iconfont-arrows-right monthSelector">Insert meaningful text here for accessibility</span></TH>
</TR>

<TR><TH scope="col">Sun</TH><TH scope="col">Mon</TH><TH scope="col">Tue</TH><TH scope="col">Wed</TH>
<TH scope="col">Thu</TH><TH scope="col">Fri</TH><TH scope="col">Sat</TH></TR>
</thead>
<TBODY ID="tableBody"></TBODY>
<TR>
    <TD COLSPAN=7>
    <FORM name="dateChooser" ID="dateChooser" class="aui">
        <SELECT ID="chooseMonth" name="chooseMonth">
    	</SELECT>
    <SELECT NAME="chooseYear">
    </SELECT>
    </FORM>
   </TD>
</TR>
</TABLE>
